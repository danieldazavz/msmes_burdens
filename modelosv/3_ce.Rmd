---
title: "Modelo V4"
author: "D. Daza"
date: "`r format(Sys.time(), '%B %d, %Y | %H:%M:%S | %Z')`"
output:
  word_document:
    toc: yes
    toc_depth: 2
header-includes:
  - \usepackage{newtxtext,newtxmath}
  - \usepackage{booktabs}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA,
                      fig.align = "center")
```

# 0. Empecemos

```{r, echo=FALSE}

#Paquetería que será utilizada

library(sjPlot)
library(haven)
library(tidyverse)
library(broom)
library(dplyr)
library(DT)
library(ggplot2)
library(leaflet)
library(sjmisc)
library(sjlabelled)
library(readxl)
library(kableExtra)
library(tidyr)
library(rmarkdown)
library(tinytex)
library(knitr)

library(stargazer)
library(readr)
library(data.table)
library(officer)
library(foreign)

library(officer)
library(openxlsx)
library(corrplot)
library(stringr)
library(car)

library(MASS)
library(moments)

```

Creación de vectores

``` {r, echo=FALSE}
#Definamos los códigos de los municipios de nuestro interés

claves <- c("01001", "02002", "02004", "05030", "05035", "07089", "07101", "08019", "08037", "09002",
            "09003", "09005", "09007", "09010", "09012", "09014", "09015", "09016", "09017", "11020",
            "12001", "14039", "14120", "15033", "15057", "15058", "15104", "15106", "16052", "16053",
            "19039", "20079", "21114", "22014", "24028", "25006", "26030", "27004", "28032", "30039",
            "30193", "31050")

#Creación con el nombre de los municipios que utilizaremos después

municipios <- c("Aguascalientes", "Mexicali", "Tijuana", "Saltillo", 
                        "Torreón", "Tapachula", "Tuxtla Gutiérrez", "Chihuahua",
                        "Juárez", "Azcapotzalco", "Coyoacán", "Gustavo A. Madero",
                        "Iztapalapa", "Álvaro Obregón", "Tlalpan", "Benito Juárez",
                        "Cuauhtémoc", "Miguel Hidalgo", "Venustiano Carranza", "León",
                        "Acapulco de Juárez", "Guadalajara", "Zapopan", "Ecatepec de Morelos",
                        "Naucalpan de Juárez", "Nezahualcóyotl", "Tlalnepantla de Baz", "Toluca",
                        "Lázaro Cárdenas", "Morelia", "Monterrey", "Salina Cruz",
                        "Puebla", "Querétaro", "San Luis Potosí", "Culiacán",
                        "Hermosillo", "Centro", "Reynosa", "Coatzacoalcos",
                        "Veracruz", "Mérida")
```

## 1. Base Censo Económico 2019

Ahora trabajaremos con la base del CE2019

``` {r, echo=FALSE}
#Carguemos la base de datos

#ce2019 <- read_excel("C:/Users/danie/OneDrive - CIDE/4to Semestre/Tesina/modelo/datos/LM2361-simulacion_ce.xlsx")

ce2019 <- read_dta("~/Procesamiento/Insumos/Censos Economicos/Insumo2019.dta")


#Seleccionemos las "31" variables de mi interés

ce2019 <- dplyr::select(ce2019, id_uelm, id_elm, e03, e04, e17, d100a, h001a, i100a, i200a, h421a, j011a, j010a, j203a, j300a, j400a, k610a, k620a, k631a, k635a, h414, h409, e23a, h010a, h101a, h203a, h020a, i000a, a111a, a194a, a195a, g210a)

#a111a Producción bruta total
#a194a Horas diarias trabajadas promedio por personal de producción, ventas y servicios
#a195a Horas diarias trabajadas promedio por empleados administrativos y de control
#g210  Total de días trabajados en este establecimiento durante 2018

#Empecemos creando una columna para identificar a los municipios

ce2019$clavemuni <- paste0(ce2019$e03, ce2019$e04)
                            
#Filtremos la base según los códigos de los municipios

ce2019 <- filter(ce2019, clavemuni %in% claves)

#Clasifiquemos a las empresas según su tamaño

#RE Clasifiquemos a las empresas según su tamaño
#SIZE 1

ce2019 <-  ce2019%>%
  mutate(size1 = case_when(
    h421a >= 0 & h421a <= 10 ~ 1,
    h421a >= 11 & h421a <= 50 ~ 2,
    h421a >= 51 & h421a <= 250 ~ 3,
    h421a > 250 ~ 4,
    TRUE ~ NA_real_))

ce2019$size1 <- as.factor(ce2019$size1)

#1 Micro 0 a 10
#2 Peque 11 a 50
#3 Mediana 51 a 250
#4 Grande 251+

ce2019 <- ce2019 %>%
  mutate(
    tamano_1 = case_when(
      size1 == 1 ~ "Micro",
      size1 == 2 ~ "Pequeña",
      size1 == 3 ~ "Mediana",
      size1 == 4 ~ "Grande")
  )

ce2019$tamano_1 <- as.factor(ce2019$tamano_1)

#SIZE2

ce2019 <- ce2019 %>%
  mutate(size2 = case_when(
    h421a >= 0 & h421a <= 5 ~ 1,
    h421a >= 6 & h421a <= 10 ~ 2,
    h421a >= 11 & h421a <= 50 ~ 3,
    h421a > 50 ~ 4,
    TRUE ~ NA_real_))

ce2019$size2 <- as.factor(ce2019$size2)

#1 Micro 0 a 5
#2 Peque 6 a 10
#3 Mediana 11 a 50
#4 Grande 51+

ce2019 <- ce2019 %>%
  mutate(
    tamano_2 = case_when(
      size2 == 1 ~ "Micro",
      size2 == 2 ~ "Pequeña",
      size2 == 3 ~ "Mediana",
      size2 == 4 ~ "Grande")
  )

ce2019$tamano_2 <- as.factor(ce2019$tamano_2)

```

ELiminar sectores 21, 22, 48, 49 y 52

Eliminar establecimientos del sector servicios con más de 15,000 trabajadores porque se trata de empresas de outsourcing que reportaron a sus trabajadores como si laboraran en el establecimiento*

```{r, echo=FALSE}
# Lista de códigos a excluir
secto_delete <- c("532411", "611311", "334110", "512112", "561330", "327213", "721111", "713941", "312221",
                  "711311", "622111", "324110", "513120", "561110", "321999", "531114", "321920", "322122",
                  "531113", "327310", "312142")

# Convertir a string
ce2019$e17 <- as.character(ce2019$e17)

ce2019f <- ce2019 %>%
  # Filtrar por códigos específicos
  filter(!e17 %in% secto_delete) %>%
  # Filtrar por inicios de códigos
  filter(!(str_sub(e17, start = 1, end = 2) %in% c("21", "22", "23", "48", "49", "52")))

ce2019f <- ce2019f %>%
  mutate(Sector = case_when(
    str_sub(e17, start = 1, end = 2) %in% c("31", "32", "33") ~ "Manufacturas",
    str_sub(e17, start = 1, end = 2) %in% c("43", "46") ~ "Comercio",
    str_sub(e17, start = 1, end = 2) %in% c("51", "53", "54", "55", "56", "61", "62", "71", "72", "81") ~ "Servicios",
    TRUE ~ NA_character_ # Para cualquier otro caso, asigna NA
  ))

# Cuenta los NA en la variable "Sector"
na_sector <- sum(is.na(ce2019f$Sector))

# Imprimir el resultado
print(paste("Número de NA en la variable 'Sector':", na_sector))

#Filtremos observaciones NA
ce2019f <- filter(ce2019f, !(Sector == "NA"))

#Filtremos las empresas de outsourcing
ce2019f <- ce2019f %>%
  filter(!(Sector == "Servicios" & h421a > 15000))

```

Eliminación de valores NA para las imputaciones de salario

```{r, echo=FALSE}

# Cuenta los NA en la variable "j010a"
na_j010a <- sum(is.na(ce2019f$j010a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'j010a':", na_j010a))

# Cuenta los NA en la variable "j203a"
na_j203a <- sum(is.na(ce2019f$j203a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'j203a':", na_j203a))

# Cuenta los NA en la variable "h101a"
na_h101a <- sum(is.na(ce2019f$h101a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'h101a':", na_h101a))

# Cuenta los NA en la variable "h203a"
na_h203a <- sum(is.na(ce2019f$h203a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'h203a':", na_h203a))

# Cuenta los NA en la variable "i000a"
na_i000a <- sum(is.na(ce2019f$i000a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'i000a':", na_i000a))

# Cuenta los NA en la variable "h020a"
na_h020a <- sum(is.na(ce2019f$h020a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'h020a':", na_h020a))

#Filtramemos la base en su caso

ce2019i <- ce2019f %>%
  filter(!is.na(j010a), !is.na(j203a), !is.na(h101a), !is.na(h203a), !is.na(i000a), !is.na(h020a))

```

## 1.1 Imputación de salario

```{r, echo=FALSE}
#ETAPA 1
# Paso 1: Calcular el salario promedio para los establecimientos con menos de 10 empleados
salario_promedio <-  ce2019i %>%
  filter(h421a < 10) %>%
  mutate(salario_promedio = (j010a + j203a) / (h101a + h203a)) %>%
  group_by(e03, e17) %>%
  summarise(salario_promedio = mean(salario_promedio, na.rm = TRUE))

# Paso 2: Asignar el salario promedio a h020a e i000a
 ce2019i <-  ce2019i %>%
  left_join(salario_promedio, by = c("e03", "e17")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         salario_promedio = as.numeric(salario_promedio),
         comp_pro = h020a * salario_promedio,
         comp_nd = i000a * salario_promedio)

# Cuenta los NA para saber cuántos no valores no pudieron imputarse
na_salario <- sum(is.na(ce2019i$salario_promedio))

# Imprimir el resultado
print(paste("Número de NA en la variable 'salario_promedio':", na_salario))

#ETAPA 2
# Definir una nueva columna 'e17_5' con los primeros 5 dígitos de 'e17'
 ce2019i <-  ce2019i %>%
  mutate(e17_5 = substr(e17, 1, 5))

# Paso 1: Calcular el salario promedio para los establecimientos con menos de 10 empleados, agrupados por estado y los primeros 5 dígitos del sector
salario_promedio_5 <-  ce2019i %>%
  filter(h421a < 10 & is.na(salario_promedio)) %>%
  mutate(salario_promedio = (j010a + j203a) / (h101a + h203a)) %>%
  group_by(e03, e17_5) %>%
  summarise(salario_promedio = mean(salario_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar el salario promedio a h020a e i000a para aquellos trabajadores que aún no tienen un salario imputado
 ce2019i <-  ce2019i %>%
  left_join(salario_promedio_5, by = c("e03" = "e03", "e17_5" = "e17_5"), suffix = c("", "_5")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         salario_promedio_5 = as.numeric(salario_promedio_5),
         comp_pro = ifelse(is.na(comp_pro), h020a * salario_promedio_5, comp_pro),
         comp_nd = ifelse(is.na(comp_nd), i000a * salario_promedio_5, comp_nd))

# ETAPA 3
# Definir una nueva columna 'e17_4' con los primeros 4 dígitos de 'e17'
 ce2019i <-  ce2019i %>%
  mutate(e17_4 = substr(e17, 1, 4))

# Paso 1: Calcular el salario promedio para los establecimientos con menos de 10 empleados, agrupados por estado y los primeros 4 dígitos del sector
salario_promedio_4 <-  ce2019i %>%
  filter(h421a < 10 & is.na(salario_promedio) & is.na(salario_promedio_5)) %>%
  mutate(salario_promedio = (j010a + j203a) / (h101a + h203a)) %>%
  group_by(e03, e17_4) %>%
  summarise(salario_promedio = mean(salario_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar el salario promedio a h020a e i000a para aquellos trabajadores que aún no tienen un salario imputado
 ce2019i <-  ce2019i %>%
  left_join(salario_promedio_4, by = c("e03" = "e03", "e17_4" = "e17_4"), suffix = c("", "_4")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         salario_promedio_4 = as.numeric(salario_promedio_4),
         comp_pro = ifelse(is.na(comp_pro), h020a * salario_promedio_4, comp_pro),
         comp_nd = ifelse(is.na(comp_nd), i000a * salario_promedio_4, comp_nd))

# ETAPA 4
# Paso 1: Calcular el salario promedio para los establecimientos con menos de 10 empleados, agrupados solo por el sector de 6 dígitos (nacional)
salario_promedio_6_nac <-  ce2019i %>%
  filter(h421a < 10 & is.na(salario_promedio) & is.na(salario_promedio_5) & is.na(salario_promedio_4)) %>%
  mutate(salario_promedio = (j010a + j203a) / (h101a + h203a)) %>%
  group_by(e17) %>%
  summarise(salario_promedio = mean(salario_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar el salario promedio a h020a e i000a para aquellos trabajadores que aún no tienen un salario imputado
 ce2019i <-  ce2019i %>%
  left_join(salario_promedio_6_nac, by = "e17", suffix = c("", "_6_nac")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         salario_promedio_6_nac = as.numeric(salario_promedio_6_nac),
         comp_pro = ifelse(is.na(comp_pro), h020a * salario_promedio_6_nac, comp_pro),
         comp_nd = ifelse(is.na(comp_nd), i000a * salario_promedio_6_nac, comp_nd))

# ETAPA 5
# Paso 1: Calcular el salario promedio para los establecimientos con menos de 10 empleados, agrupados solo por el sector de 5 dígitos (nacional)
salario_promedio_5_nac <-  ce2019i %>%
  filter(h421a < 10 & is.na(salario_promedio) & is.na(salario_promedio_5) & is.na(salario_promedio_4) & is.na(salario_promedio_6_nac)) %>%
  mutate(salario_promedio = (j010a + j203a) / (h101a + h203a)) %>%
  group_by(e17_5) %>%
  summarise(salario_promedio = mean(salario_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar el salario promedio a h020a e i000a para aquellos trabajadores que aún no tienen un salario imputado
 ce2019i <-  ce2019i %>%
  left_join(salario_promedio_5_nac, by = "e17_5", suffix = c("", "_5_nac")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         salario_promedio_5_nac = as.numeric(salario_promedio_5_nac),
         comp_pro = ifelse(is.na(comp_pro), h020a * salario_promedio_5_nac, comp_pro),
         comp_nd = ifelse(is.na(comp_nd), i000a * salario_promedio_5_nac, comp_nd))
 
 
#Eliminemos las columnas que ya no usaremos
 
ce2019i <- dplyr::select(ce2019i, -salario_promedio_5, -salario_promedio_4,
                  -salario_promedio_5_nac, -salario_promedio_6_nac)
 
```

Verificación de datos y creación de variable total_remu

```{r, echo=FALSE}
#Revisemos si hubo datos que no pudieron imputarse

# Cuenta los NA en la variable "comp_pro"
na_comppro <- sum(is.na( ce2019i$comp_pro))

# Imprimir el resultado
print(paste("Número de NA en la variable 'comp_pro':", na_comppro))

# Cuenta los NA en la variable "comp_nd"
na_compnd <- sum(is.na( ce2019i$comp_nd))

# Imprimir el resultado
print(paste("Número de NA en la variable 'comp_nd':", na_compnd))

#Filtramemos la base en su caso

ce2019i <-  ce2019i %>%
  filter(!is.na(comp_pro), !is.na(comp_nd))

#Calculemos el total de remuneraciones

#Total de remuneraciones
 ce2019i <-  ce2019i %>%
  mutate(total_remu = j010a + j203a + coalesce(comp_pro, 0) + coalesce(comp_nd, 0))

# Cuenta los NA para saber si hubo variables j010a y j203a con NA
na_remu <- sum(is.na( ce2019i$total_remu))

# Imprimir el resultado
print(paste("Número de NA en la variable 'total_remu':", na_remu))

#Técnicamente este resultado debería ser 0 porque se eliminaron antes de realizar la imputación

#Eliminemos objetos

rm(salario_promedio, salario_promedio_5, salario_promedio_4,

                     salario_promedio_5_nac, salario_promedio_6_nac)
rm(ce2019f)

```

Eliminación de valores NA para las imputaciones de horas trabajadas

```{r, echo=FALSE}
# Cuenta los NA en la variable "a194a"
na_a194a <- sum(is.na( ce2019i$a194a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'a194a':", na_a194a))

# Cuenta los NA en la variable "a195a"
na_a195a <- sum(is.na( ce2019i$a195a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'a195a':", na_a195a))

# Cuenta los NA en la variable "g210"
na_g210a <- sum(is.na( ce2019i$g210a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'g210a':", na_g210a))

#Filtramemos la base en su caso

ce2019i <- ce2019i %>%
  filter(!is.na(a195a), !is.na(a194a), !is.na(g210a))

# Contar el número de observaciones donde 'g210a' es igual a 0
#Número de días que operó el negocio

g210a_zero <- sum(ce2019i$g210a == 0)

# Imprimir el resultado
print(paste("Número de observaciones donde 'g210a' es igual a 0:", g210a_zero))

```

## 1.2 Imputación de horas trabajadas

```{r, echo=FALSE}
#ETAPA 1
# Paso 1: Calcular las horas promedio para los establecimientos con menos de 10 empleados
horas_promedio <-  ce2019i %>%
  filter(h421a < 10) %>%
  mutate(horas_promedio = ifelse((h101a + h203a) != 0, (((h101a * a194a) + (h203a * a195a))/ (h101a + h203a)), NA)) %>%
  group_by(e03, e17) %>%
  summarise(horas_promedio = mean(horas_promedio, na.rm = TRUE))

# Paso 2: Asignar las horas promedio a h020a e i000a
ce2019i <-  ce2019i %>%
  left_join(horas_promedio, by = c("e03", "e17")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         horas_promedio = ifelse(!is.na(horas_promedio), as.numeric(horas_promedio), NA),
         horas_pro = h020a * horas_promedio,
         horas_nd = i000a * horas_promedio)

# Cuenta los NA para saber cuántos no valores no pudieron imputarse
na_horas <- sum(is.na(ce2019i$horas_promedio))


# Imprimir el resultado
print(paste("Número de NA en la variable 'horas_promedio':", na_horas))

# Cuenta los valores Inf
inf_horas <- sum(is.infinite(ce2019i$horas_promedio))

# Imprimir el resultado
print(paste("Número de Inf en la variable 'horas_promedio':", inf_horas))

# Cuenta los valores NaN
nan_horas <- sum(is.nan(ce2019i$horas_promedio))

# Imprimir el resultado
print(paste("Número de NaN en la variable 'horas_promedio':", nan_horas))


#ETAPA 2

# Definir una nueva columna 'e17_5' con los primeros 5 dígitos de 'e17'

#Ya fue creada

# Paso 1: Calcular las horas promedio para los establecimientos con menos de 10 empleados, agrupados por estado y los primeros 5 dígitos del sector

horas_promedio_5 <-  ce2019i %>%
  filter(h421a < 10 & is.na(horas_promedio)) %>%
  mutate(horas_promedio = ifelse((h101a + h203a) != 0, (((h101a * a194a) + (h203a * a195a))/ (h101a + h203a)), NA)) %>%
  group_by(e03, e17_5) %>%
  summarise(horas_promedio = mean(horas_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar las horas promedio a h020a e i000a para aquellos trabajadores que aún no tienen horas imputadas
 ce2019i <-  ce2019i %>%
  left_join(horas_promedio_5, by = c("e03" = "e03", "e17_5" = "e17_5"), suffix = c("", "_5")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         horas_promedio_5 = ifelse(!is.na(horas_promedio_5), as.numeric(horas_promedio_5), NA),
         horas_pro = ifelse(is.na(horas_pro), h020a * horas_promedio_5, horas_pro),
         horas_nd = ifelse(is.na(horas_nd), i000a * horas_promedio_5, horas_nd))

# ETAPA 3

# Definir una nueva columna 'e17_4' con los primeros 4 dígitos de 'e17'
#Ya fue creada

# Paso 1: Calcular las horas promedio para los establecimientos con menos de 10 empleados, agrupados por estado y los primeros 4 dígitos del sector

horas_promedio_4 <-  ce2019i %>%
  filter(h421a < 10 & is.na(horas_promedio) & is.na(horas_promedio_5)) %>%
  mutate(horas_promedio = ifelse((h101a + h203a) != 0, (((h101a * a194a) + (h203a * a195a))/ (h101a + h203a)), NA)) %>%
  group_by(e03, e17_4) %>%
  summarise(horas_promedio = mean(horas_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar las horas promedio a h020a e i000a para aquellos trabajadores que aún no tienen horas imputadas

 ce2019i <-  ce2019i %>%
  left_join(horas_promedio_4, by = c("e03" = "e03", "e17_4" = "e17_4"), suffix = c("", "_4")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         horas_promedio_4 = ifelse(!is.na(horas_promedio_4), as.numeric(horas_promedio_4), NA),
         horas_pro = ifelse(is.na(horas_pro), h020a * horas_promedio_4, horas_pro),
         horas_nd = ifelse(is.na(horas_nd), i000a * horas_promedio_4, horas_nd))

# ETAPA 4
# Paso 1: Calcular las horas promedio para los establecimientos con menos de 10 empleados, agrupados solo por el sector de 6 dígitos (nacional)

horas_promedio_6_nac <-  ce2019i %>%
  filter(h421a < 10 & is.na(horas_promedio) & is.na(horas_promedio_5) & is.na(horas_promedio_4)) %>%
  mutate(horas_promedio = ifelse((h101a + h203a) != 0, (((h101a * a194a) + (h203a * a195a))/ (h101a + h203a)), NA)) %>%
  group_by(e17) %>%
  summarise(horas_promedio = mean(horas_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar las horas promedio a h020a e i000a para aquellos trabajadores que aún no tienen horas imputadas

 ce2019i <-  ce2019i %>%
  left_join(horas_promedio_6_nac, by = "e17", suffix = c("", "_6_nac")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         horas_promedio_6_nac = ifelse(!is.na(horas_promedio_6_nac), as.numeric(horas_promedio_6_nac), NA),
         horas_pro = ifelse(is.na(horas_pro), h020a * horas_promedio_6_nac, horas_pro),
         horas_nd = ifelse(is.na(horas_nd), i000a * horas_promedio_6_nac, horas_nd))

# ETAPA 5
# Paso 1: Calcular las horas promedio para los establecimientos con menos de 10 empleados, agrupados solo por el sector de 5 dígitos (nacional)

horas_promedio_5_nac <-  ce2019i %>%
  filter(h421a < 10 & is.na(horas_promedio) & is.na(horas_promedio_5) & is.na(horas_promedio_4) & is.na(horas_promedio_6_nac)) %>%
  mutate(horas_promedio = ifelse((h101a + h203a) != 0, (((h101a * a194a) + (h203a * a195a))/ (h101a + h203a)), NA)) %>%
  group_by(e17_5) %>%
  summarise(horas_promedio = mean(horas_promedio, na.rm = TRUE), .groups = 'drop')

# Paso 2: Asignar las horas promedio a h020a e i000a para aquellos trabajadores que aún no tienen horas imputadas
 ce2019i <-  ce2019i %>%
  left_join(horas_promedio_5_nac, by = "e17_5", suffix = c("", "_5_nac")) %>%
  mutate(h020a = as.numeric(h020a),
         i000a = as.numeric(i000a),
         horas_promedio_5_nac = ifelse(!is.na(horas_promedio_5_nac), as.numeric(horas_promedio_5_nac), NA),
         horas_pro = ifelse(is.na(horas_pro), h020a * horas_promedio_5_nac, horas_pro),
         horas_nd = ifelse(is.na(horas_nd), i000a * horas_promedio_5_nac, horas_nd))
 
#Eliminemos variables que ya no usaremos
 
ce2019i <- dplyr::select(ce2019i, -horas_promedio_4, -horas_promedio_5, -horas_promedio_5_nac, -horas_promedio_6_nac)

```

Verificación de datos y creación de variables para total horas diarias y total horas anuales

```{r, echo=FALSE}
#Revisemos si hubo datos que no pudieron imputarse

# Cuenta los NA en la variable "horas_pro"
na_horaspro <- sum(is.na( ce2019i$horas_pro))

# Imprimir el resultado
print(paste("Número de NA en la variable 'horas_pro':", na_horaspro))

# Cuenta los NA en la variable "horas_nd"
na_horasnd <- sum(is.na( ce2019i$horas_nd))

# Imprimir el resultado
print(paste("Número de NA en la variable 'horas_nd':", na_horasnd))

#Filtramemos la base en su caso

ce2019i <-  ce2019i %>%
  filter(!is.na(horas_pro), !is.na(horas_nd))

#Calculemos el total de horas diarias y anuales

#Total de horas diarias para el personal de producción y el de servicios

ce2019i <- ce2019i %>%
  mutate(a194a_total = a194a * h101a) %>%
  mutate(a195a_total = a195a * h203a)

#Total de horas
 ce2019i <-  ce2019i %>%
  mutate(to_horas_d = a194a_total + a195a_total + coalesce(horas_pro, 0) + coalesce(horas_nd, 0))

# Cuenta los NA para saber si hubo variables a194a y a195a con NA
na_horas <- sum(is.na( ce2019i$to_horas_d))

# Imprimir el resultado
print(paste("Número de NA en la variable 'to_horas_d':", na_horas))

#Técnicamente este resultado debería ser 0 porque se eliminaron antes de realizar la imputación

#Creamos una nueva variable para el total de horas trabajadas anualmente

ce2019i <-  ce2019i %>%
  mutate(h_anual = ifelse(g210a != 0, to_horas_d * g210a, to_horas_d * 255))

 # Cuenta los NA para saber si hubo variables h_anual con NA
na_hanual <- sum(is.na( ce2019i$h_anual))

# Imprimir el resultado
print(paste("Número de NA en la variable 'h_anual':", na_hanual))

# Contar el número de observaciones donde 'h_anual' es igual a 0
hanual_zero <- sum(ce2019i$h_anual == 0)

# Imprimir el resultado
print(paste("Número de observaciones donde 'h_anual' es igual a 0:", hanual_zero))

#Filtremos

ce2019i <-  ce2019i %>%
  filter(h_anual != 0)
 
#Eliminemos objetos

rm(horas_promedio_4, horas_promedio_5, horas_promedio_5_nac, horas_promedio_6_nac)

```

Proxy de productividad

```{r, echo=FALSE}

# Cuenta los NA para saber si hay variables a111a con NA
na_a111a <- sum(is.na(ce2019i$a111a))

# Imprimir el resultado
print(paste("Número de NA en la variable 'a111a':", na_a111a))

#Eliminemos los valores NA en su caso

ce2019i <- ce2019i %>%
  filter(!is.na(a111a))

#Exploremos la variable

class(ce2019i$a111a)

attributes(ce2019i$a111a)

# Contar el número de observaciones donde 'a111a' es igual a 0
a111a_zero <- sum(ce2019i$a111a == 0)

# Imprimir el resultado
print(paste("Número de observaciones donde 'a111a' es igual a 0:", a111a_zero))

#31,348 empresas tuvieron una producción bruta de 0

#Estadística descriptiva de la variable

produc <- ce2019i %>%
  summarise(n_obs = n(),
            mean_ca = round(mean(a111a), 2),
            stdev_ca = round(sd(a111a), 2),
            min_ca = round(min(a111a), 2),
            q1_ca = round(quantile(a111a, probs = (0.25)), 2),
            q3_ca = round(quantile(a111a, probs = (0.75)), 2),
            max_ca = round(max(a111a), 2)) %>%
  rename("No. obs." = n_obs,
         "Media" = mean_ca,
         "Desv. estándar" = stdev_ca,
         "Mínimo" = min_ca,
         "Q1" = q1_ca,
         "Q3" = q3_ca,
         "Máximo" = max_ca)

# Tablita filtrada
tab0 <- produc %>%
  kable(caption = "Estadística descriptiva: productividad",
        format.args = list(decimal.mark = ".", big.mark = ","),
        format = "pandoc", align = "c")

tab0

#Realicemos alguna transformación de la variable si es necesario

ce2019i <- ce2019i %>%
  mutate(a111a_mil = a111a*1000)

#Estimemos la productividad promedio

 ce2019i <-  ce2019i %>%
  mutate(productividad = a111a/h_anual)
 
#Revisemos si hay datos faltantes
 
# Cuenta los NA en la variable "productividad"
na_productivity <- sum(is.na(ce2019i$productividad))

# Imprimir el resultado
print(paste("Número de NA en la variable 'productividad':", na_productivity))

#Eliminemos los valores NA en su caso

ce2019i <- ce2019i %>%
  filter(!is.na(productividad))

```

# 2 Creación del indice de formalidad de acuerdo a Levy (2018)

Con la base limpia y filtrada, y hechas las imputaciones de salario, replicaremos el índice de formalidad de Levy (2018) y clasificaremos a las empresas según este.

Índice = Pagos a la seguridad social contributiva / (salarios trabajadores asalariados + Pagos trabajadores no asalariados)

```{r, echo=FALSE}
# MI CÓDIGO AQUÍ

#Para completar valores faltantes

ce2019i <-  ce2019i[complete.cases(ce2019i[, c("j300a")]), ]

#Indice

ce2019i$in_levy <- ( ce2019i$j300a) / ( ce2019i$total_remu)

#Clasificacion de empresas

ce2019i$tipo_levy <- ifelse( ce2019i$in_levy >= 0.18, 1, 
                             ifelse( ce2019i$in_levy > 0, 3, 2))

ce2019i$tipo_levy <- factor(ce2019i$tipo_levy, levels = 1:3)

#1 = formal
#2 = informal
#3 = mixta

```

Verificación de datos

```{r, echo=FALSE}
#Revisión de valores faltantes

 ce2019i %>%
  summarise(na_size2 = sum(is.na(size2)), 
            na_tipo_levy = sum(is.na(tipo_levy)),
            na_productividad = sum(is.na(productividad)))

#Si existen valores NA, se eliminan

 ce2019i <-  ce2019i %>%
  drop_na(size2, tipo_levy, productividad)

#Verifiquemos

sum_size <-  ce2019i %>%
  summarise(sum_micro = sum(size2 == 1, na.rm = TRUE),
            sum_pequena = sum(size2 == 2, na.rm = TRUE),
            sum_mediana = sum(size2 == 3, na.rm = TRUE),
            sum_grande = sum(size2 == 4, na.rm = TRUE)) %>%
  mutate(sum_size = sum_micro + sum_pequena + sum_mediana + sum_grande)

sum_tipo <-  ce2019i %>%
  summarise(sum_formal = sum(tipo_levy == 1, na.rm = TRUE),
            sum_informal = sum(tipo_levy == 2, na.rm = TRUE),
            sum_mixta = sum(tipo_levy == 3, na.rm = TRUE)) %>%
  mutate(sum_tipo = sum_formal + sum_informal + sum_mixta)

nrow(ce2019i) == sum_size$sum_size & nrow(ce2019i) == sum_tipo$sum_tipo

#Si este código devuelve TRUE, entonces todas las empresas están clasificadas tanto por tamaño como por tipo

```

## 2.1 Estimación de la productividad promedio por tamaño y tipo de empresas

```{r, echo=FALSE}
####Productividad según el tamaño de las empresas

# Primero agrupamos por municipio y tamaño, y calculamos la productividad promedio
productivity_size <- ce2019i %>%
  group_by(clavemuni, size2) %>%
  summarise(productivity_prom = mean(productividad, na.rm = TRUE))

# Usamos pivot_wider para obtener las columnas de productividad por tamaño de empresa
productivity_size <- productivity_size %>%
  pivot_wider(names_from = size2, values_from = productivity_prom)

# Reordenar las columnas
productivity_size <- productivity_size %>% dplyr::select(`1`, `2`, `3`, `4`)

# Renombramos las columnas para mayor claridad
names(productivity_size) <- c("clavemuni", "pro_micro", "pro_pequena", "pro_mediana", "pro_grande")


#####Productividad según el tipo de las empresas

# Primero agrupamos por municipio y tamaño, y calculamos la productividad promedio
productivity_tipo <- ce2019i %>%
  group_by(clavemuni, tipo_levy) %>%
  summarise(productivity_prom = mean(productividad, na.rm = TRUE))

# Usamos pivot_wider para obtener las columnas de productividad por tamaño de empresa
productivity_tipo <- productivity_tipo %>%
  pivot_wider(names_from = tipo_levy, values_from = productivity_prom)

# Reordenar las columnas

productivity_tipo <- productivity_tipo %>% dplyr::select(`1`, `2`, `3`)

# Renombramos las columnas para mayor claridad

names(productivity_tipo) <- c("clavemuni", "pro_formal", "pro_informal", "pro_mixta")


#####Productividad según tamaño y tipo de empresas

productivity_size_type <- ce2019i %>%
  group_by(clavemuni, size2, tipo_levy) %>%
  summarise(productivity_prom = mean(productividad, na.rm = TRUE)) %>%
  mutate(size_type = interaction(size2, tipo_levy, sep = "_")) %>%
  group_by(clavemuni, size_type) %>%
  summarise(productivity_prom = mean(productivity_prom, na.rm = TRUE)) %>%
  pivot_wider(names_from = size_type, values_from = productivity_prom)

#Selección de variables

productivity_size_type <- productivity_size_type %>% dplyr::select(`1_1`, `1_2`, `1_3`, 
                                                            `2_1`, `2_2`, `2_3`, 
                                                            `3_1`, `3_2`, `3_3`,
                                                            `4_1`, `4_2`, `4_3`)

# Renombramos las columnas para mayor claridad

names(productivity_size_type) <- c("clavemuni", "prod_prom_mi_m", "prod_prom_pe_f", 
                                   "prod_prom_pe_m", "prod_prom_me_m", "prod_prom_gr_m")

names(productivity_size_type) <- c("clavemuni", 
                                   "prod_prom_mi_f", "prod_prom_mi_i", "prod_prom_mi_m",
                                   "prod_prom_pe_f", "prod_prom_pe_i", "prod_prom_pe_m",
                                   "prod_prom_me_f", "prod_prom_me_i", "prod_prom_me_m",
                                   "prod_prom_gr_f", "prod_prom_gr_i", "prod_prom_gr_m")

#Unimos las bases de datos

productivity_full <- merge(productivity_size, productivity_tipo, by = "clavemuni", all = TRUE)

productivity_full <- merge(productivity_full, productivity_size_type, by = "clavemuni", all = TRUE)

str(productivity_full)

colnames(productivity_full)

#Guardamos el dataframe

write.xlsx(productivityfull, "~/Procesamiento/Trabajo/productivityfull.xlsx")

```

## 2.2 Creación de bases de datos según la clasificación de formalidad

A partir de los índices y la categorización creadas, ahora trabajaremos creando una nueva base de datos

Selecciona el tamaño de empresa (size1 o size2) según lo obtenido en ENCRIGE

```{r, echo=FALSE}
#MI CÓDIGO AQUI

#Creemos una base de datos para cada una de las clasificaciones

#LEVY SIZE 2
levy1 <-  ce2019i %>%
  group_by(clavemuni) %>%
  summarize(
    formal = sum(tipo_levy == 1),
    informal = sum(tipo_levy == 2),
    mixta = sum(tipo_levy == 3),
    micro = sum(size2 == 1),
    pequeña = sum(size2 == 2),
    mediana = sum(size2 == 3),
    grande = sum(size2 == 4),
    mi_f = sum(size2 == 1 & tipo_levy == 1),
    mi_i = sum(size2 == 1 & tipo_levy == 2),
    mi_m = sum(size2 == 1 & tipo_levy == 3),
    pe_f = sum(size2 == 2 & tipo_levy == 1),
    pe_i = sum(size2 == 2 & tipo_levy == 2),
    pe_m = sum(size2 == 2 & tipo_levy == 3),
    me_f = sum(size2 == 3 & tipo_levy == 1),
    me_i = sum(size2 == 3 & tipo_levy == 2),
    me_m = sum(size2 == 3 & tipo_levy == 3),
    gr_f = sum(size2 == 4 & tipo_levy == 1),
    gr_i = sum(size2 == 4 & tipo_levy == 2),
    gr_m = sum(size2 == 4 & tipo_levy == 3)) %>%
  mutate(    totaltipo = formal + informal + mixta,
             totalsize = micro + pequeña + mediana + grande,
    p_formal = ifelse(totaltipo > 0, formal/totaltipo, 0),
    p_informal = ifelse(totaltipo > 0, informal/totaltipo, 0),
    p_mixta = ifelse(totaltipo > 0, mixta/totaltipo, 0),
    p_micro = ifelse(totalsize > 0, micro/totalsize, 0),
    p_pequeña = ifelse(totalsize > 0, pequeña/totalsize, 0),
    p_mediana = ifelse(totalsize > 0, mediana/totalsize, 0),
    p_grande = ifelse(totalsize > 0, grande/totalsize, 0),
    p_mi_f = ifelse(micro > 0, mi_f / micro, 0),
    p_mi_i = ifelse(micro > 0, mi_i / micro, 0),
    p_mi_m = ifelse(micro > 0, mi_m / micro, 0),
    p_pe_f = ifelse(pequeña > 0, pe_f / pequeña, 0),
    p_pe_i = ifelse(pequeña > 0, pe_i / pequeña, 0),
    p_pe_m = ifelse(pequeña > 0, pe_m / pequeña, 0),
    p_me_f = ifelse(mediana > 0, me_f / mediana, 0),
    p_me_i = ifelse(mediana > 0, me_i / mediana, 0),
    p_me_m = ifelse(mediana > 0, me_m / mediana, 0),
    p_gr_f = ifelse(grande > 0, gr_f / grande, 0),
    p_gr_i = ifelse(grande > 0, gr_i / grande, 0),
    p_gr_m = ifelse(grande > 0, gr_m / grande, 0))

```

Unión de dataframes

```{r, echo=FALSE}

basefull <- merge(levy1, productivity_full, by = "clavemuni", all = TRUE)

```

Tablas por tamaño

```{r, results='asis'}
#Tablas
tab1 <- levy1 %>%
  summarize(
    micro = sum(micro),
    pequeña = sum(pequeña),
    mediana = sum(mediana),
    grande = sum(grande),
    totalsize = sum(totalsize))

tab1_k <- kable(tab1, format = "pandoc", 
                      caption = "Tabla 1. Empresas según su tamaño", 
                      col.names = c("Micro", "Pequeña", "Mediana", "Grande", "Total"), 
                      align = "c")

levy_municipios <- levy1 %>%
  mutate(nombre_municipio = municipios[match(clavemuni, claves)]) %>%
  dplyr::select(nombre_municipio, micro, pequeña, mediana, grande, totalsize)

tab2_k <- kable(levy_municipios, format = "pandoc",
                      caption = "Tabla 2. Empresas según su tamaño y tipo por municipio",
                      col.names = c("Municipio", "Micro", "Pequeña", "Mediana", "Grande", "Total"),
                      align = c("l", "c", "c", "c", "c", "c"))

#Tablitas

tab1_k
tab2_k

```

Tablas por tipo

```{r, results='asis'}
#Tablas
tab3 <- levy1 %>%
  summarize(formal = sum(formal),
    informal = sum(informal),
    mixta = sum(mixta),
    totaltipo = sum(totaltipo))

tab3_k <- kable(tab3, format = "pandoc", 
                      caption = "Tabla 3. Empresas según su tipo", 
                      col.names = c("Formal", "Informal", "Mixta", "Total"), 
                      align = "c")

levy_municipios2 <- levy1 %>%
  mutate(nombre_municipio = municipios[match(clavemuni, claves)]) %>%
  dplyr::select(nombre_municipio, formal, informal, mixta, totaltipo)

tab4_k <- kable(levy_municipios2, format = "pandoc",
                      caption = "Tabla 4. Empresas según su tipo por municipio",
                      col.names = c("Municipio", "Formal", "Informal", "Mixta", "Total"),
                      align = c("l", "c", "c", "c", "c"))

#Tablitas

tab3_k
tab4_k

```

Estadística descriptiva: productividad todas las empresas TAMAÑO 2

```{r}
#Esto es para que aparezcan ordenados los datos
ce2019i$tamano_2 <- factor(ce2019i$tamano_2, levels = c("Micro", "Pequeña", "Mediana", "Grande"))

###Todos los sectores
ds_productivity <- ce2019i %>%
  group_by(tamano_2) %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab5 <- ds_productivity %>%
  kable("pipe", caption = "Productividad todos los sectores y empresas") %>%
  kable_styling()

tab5

###Sector COMERCIO
ds_productivity_co <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(Sector == "Comercio") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab6 <- ds_productivity_co %>%
  kable("pipe", caption = "Productividad sector comercio") %>%
  kable_styling()

tab6

###Sector SERVICIOS
ds_productivity_se <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(Sector == "Servicios") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab8 <- ds_productivity_se %>%
  kable("pipe", caption = "Productividad sector servicios") %>%
  kable_styling()

tab8

###Sector MANUFACTURAS
ds_productivity_ma <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(Sector == "Manufacturas") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab7 <- ds_productivity_ma %>%
  kable("pipe", caption = "Productividad sector manufacturas") %>%
  kable_styling()

tab7

```

Estadística descriptiva: productividad todas las empresas TAMAÑO 1

Aproximadamente se deberían obtener valores cercanos a 103.11, 223.05,388.09, 638.84 para cada estrato respectivamente.

```{r}

#Esto es para que aparezcan ordenados los datos
ce2019i$tamano_1 <- factor(ce2019i$tamano_1, levels = c("Micro", "Pequeña", "Mediana", "Grande"))

###Todos los sectores
ds_productivity <- ce2019i %>%
  group_by(tamano_1) %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab5 <- ds_productivity %>%
  kable("pipe", caption = "Productividad todos los sectores y empresas") %>%
  kable_styling()

tab5

###Sector COMERCIO
ds_productivity_co <- ce2019i %>%
  group_by(Sector, tamano_1) %>%
  filter(Sector == "Comercio") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab6 <- ds_productivity_co %>%
  kable("pipe", caption = "Productividad sector comercio") %>%
  kable_styling()

tab6

###Sector SERVICIOS
ds_productivity_se <- ce2019i %>%
  group_by(Sector, tamano_1) %>%
  filter(Sector == "Servicios") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab8 <- ds_productivity_se %>%
  kable("pipe", caption = "Productividad sector servicios") %>%
  kable_styling()

tab8

###Sector MANUFACTURAS
ds_productivity_ma <- ce2019i %>%
  group_by(Sector, tamano_1) %>%
  filter(Sector == "Manufacturas") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab7 <- ds_productivity_ma %>%
  kable("pipe", caption = "Productividad sector manufacturas") %>%
  kable_styling()

tab7

```

Estadística descriptiva: productividad empresas formales

```{r}

###Todos los sectores
ds_productivity <- ce2019i %>%
  group_by(tamano_2) %>%
  filter(tipo_levy == 1) %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab9 <- ds_productivity %>%
  kable("pipe", caption = "Productividad todos los sectores, empresas formales") %>%
  kable_styling()

tab9


###Sector COMERCIO
ds_productivity_co <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(tipo_levy == 1, Sector == "Comercio") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab10 <- ds_productivity_co %>%
  kable("pipe", caption = "Productividad sector comercio, empresas formales") %>%
  kable_styling()

tab10

###Sector SERVICIOS
ds_productivity_se <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(tipo_levy == 1, Sector == "Servicios") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab12 <- ds_productivity_se %>%
  kable("pipe", caption = "Productividad sector servicios, empresas formales") %>%
  kable_styling()

tab12

###Sector MANUFACTURAS
ds_productivity_ma <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(tipo_levy == 1, Sector == "Manufacturas") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab11 <- ds_productivity_ma %>%
  kable("pipe", caption = "Productividad sector manufacturas, empresas formales") %>%
  kable_styling()

tab11

```

Estadística descriptiva: productividad empresas informales

```{r}

###Todos los sectores
ds_productivity <- ce2019i %>%
  group_by(tamano_2) %>%
  filter(tipo_levy == 2) %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab13 <- ds_productivity %>%
  kable("pipe", caption = "Productividad todos los sectores, empresas informales") %>%
  kable_styling()

tab13


###Sector COMERCIO
ds_productivity_co <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(tipo_levy == 2, Sector == "Comercio") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab14 <- ds_productivity_co %>%
  kable("pipe", caption = "Productividad sector comercio, empresas informales") %>%
  kable_styling()

tab14

###Sector SERVICIOS
ds_productivity_se <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(tipo_levy == 2, Sector == "Servicios") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab15 <- ds_productivity_se %>%
  kable("pipe", caption = "Productividad sector servicios, informales") %>%
  kable_styling()

tab15

###Sector MANUFACTURAS
ds_productivity_ma <- ce2019i %>%
  group_by(Sector, tamano_2) %>%
  filter(tipo_levy == 2, Sector == "Manufacturas") %>%
  summarise(Obs = n(),
            Mean = mean(productividad, na.rm = TRUE),
            Sd = sd(productividad, na.rm = TRUE),
            Min = min(productividad, na.rm = TRUE),
            Q1 = quantile(productividad, 0.25, na.rm = TRUE),
            Q3 = quantile(productividad, 0.75, na.rm = TRUE),
            Max = max(productividad, na.rm = TRUE))

#Tablas para los resultados anteriores

tab15 <- ds_productivity_ma %>%
  kable("pipe", caption = "Productividad sector manufacturas, informales") %>%
  kable_styling()

tab15

```

Tablas productividad

```{r}

# Tabla 5: Productividad promedio por tamaño
tab5 <- productivity_full %>%
  summarise(
    Micro = mean(pro_micro, na.rm = TRUE),
    Pequeña = mean(pro_pequena, na.rm = TRUE),
    Mediana = mean(pro_mediana, na.rm = TRUE),
    Grande = mean(pro_grande, na.rm = TRUE)
  )

# Tabla 6: Productividad promedio por tamaño por municipio
tab6 <- productivity_full %>%
  group_by(clavemuni) %>%
  summarise(
    Micro = mean(pro_micro, na.rm = TRUE),
    Pequeña = mean(pro_pequena, na.rm = TRUE),
    Mediana = mean(pro_mediana, na.rm = TRUE),
    Grande = mean(pro_grande, na.rm = TRUE)
  )

# Tabla 7: Productividad promedio por tipo
tab7 <- productivity_full %>%
  summarise(
    Formal = mean(pro_formal, na.rm = TRUE),
    Informal = mean(pro_informal, na.rm = TRUE),
    Mixta = mean(pro_mixta, na.rm = TRUE)
  )

# Tabla 8: Productividad promedio por tipo por municipio
tab8 <- productivity_full %>%
  group_by(clavemuni) %>%
  summarise(
    Formal = mean(pro_formal, na.rm = TRUE),
    Informal = mean(pro_informal, na.rm = TRUE),
    Mixta = mean(pro_mixta, na.rm = TRUE)
  )

# Crear tablas kable
tab5_k <- kable(tab5, format = "pandoc", caption = "Tabla 1", align = "c")
tab6_k <- kable(tab6, format = "pandoc", caption = "Tabla 2", align = "c")
tab7_k <- kable(tab7, format = "pandoc", caption = "Tabla 3", align = "c")
tab8_k <- kable(tab8, format = "pandoc", caption = "Tabla 4", align = "c")

# Imprime las tablas

tab5_k
tab6_k
tab7_k
tab8_k

# Tabla 9: Productividad promedio por tipo y tamaño
tab9 <- productivity_full %>%
  summarise(
    Micro_Formal = mean(prod_prom_mi_f, na.rm = TRUE),
    Micro_Informal = mean(prod_prom_mi_i, na.rm = TRUE),
    Micro_Mixta = mean(prod_prom_mi_m, na.rm = TRUE),
    Pequeña_Formal = mean(prod_prom_pe_f, na.rm = TRUE),
    Pequeña_Informal = mean(prod_prom_pe_i, na.rm = TRUE),
    Pequeña_Mixta = mean(prod_prom_pe_m, na.rm = TRUE),
    Mediana_Formal = mean(prod_prom_me_f, na.rm = TRUE),
    Mediana_Informal = mean(prod_prom_me_i, na.rm = TRUE),
    Mediana_Mixta = mean(prod_prom_me_m, na.rm = TRUE),
    Grande_Formal = mean(prod_prom_gr_f, na.rm = TRUE),
    Grande_Informal = mean(prod_prom_gr_i, na.rm = TRUE),
    Grande_Mixta = mean(prod_prom_gr_m, na.rm = TRUE)
  )

# Crear tabla kable
tab9_k <- kable(tab9, format = "pandoc", caption = "Tabla 5", align = "c")

# Imprimir la tabla (solo útil si estás en una sesión interactiva de R)
tab9_k

# Tabla 10: Productividad promedio por tipo y tamaño por municipio
tab10 <- productivity_full %>%
  group_by(clavemuni) %>%
  summarise(
    Micro_Formal = mean(prod_prom_mi_f, na.rm = TRUE),
    Micro_Informal = mean(prod_prom_mi_i, na.rm = TRUE),
    Micro_Mixta = mean(prod_prom_mi_m, na.rm = TRUE),
    Pequeña_Formal = mean(prod_prom_pe_f, na.rm = TRUE),
    Pequeña_Informal = mean(prod_prom_pe_i, na.rm = TRUE),
    Pequeña_Mixta = mean(prod_prom_pe_m, na.rm = TRUE),
    Mediana_Formal = mean(prod_prom_me_f, na.rm = TRUE),
    Mediana_Informal = mean(prod_prom_me_i, na.rm = TRUE),
    Mediana_Mixta = mean(prod_prom_me_m, na.rm = TRUE),
    Grande_Formal = mean(prod_prom_gr_f, na.rm = TRUE),
    Grande_Informal = mean(prod_prom_gr_i, na.rm = TRUE),
    Grande_Mixta = mean(prod_prom_gr_m, na.rm = TRUE)
  )

# Crear tabla kable
tab10_k <- kable(tab10, format = "pandoc", caption = "Tabla 6", align = "c")

# Imprimir la tabla (solo útil si estás en una sesión interactiva de R)
tab10_k

```

Guarda las tablas

```{r}

write.xlsx(tab6, "~/Procesamiento/Trabajo/tab6.xlsx")

write.xlsx(tab8, "~/Procesamiento/Trabajo/tab8.xlsx")

write.xlsx(tab10, "~/Procesamiento/Trabajo/tab10.xlsx")

```

Guardar el dataframe

```{r}

write.xlsx(basefull, "~/Procesamiento/Trabajo/basefull.xlsx")

```
